apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-bootstrap
  namespace: platform
data:
  bootstrap.sh: |
    #!/bin/sh
    set -e
    echo "Bootstrapping Vault..."

    # Set Vault environment
    export VAULT_ADDR=https://hashicorp-vault.platform.svc:8200
    export VAULT_CACERT=/vault/ca/ca.crt

    # Enable Kubernetes auth
    vault auth enable kubernetes || echo "Kubernetes auth already enabled"

    # Configure Kubernetes auth
    vault write auth/kubernetes/config \
        kubernetes_host="https://<apiserver-host>:443" \
        kubernetes_ca_cert=@/vault/ca/ca.crt \
        token_reviewer_jwt=@/reviewer.jwt

    # Create admin policy
    cat <<EOF | vault policy write admin -
    path "*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }
    EOF

    # Enable userpass and create admin user
    vault auth enable userpass || echo "Userpass already enabled"
    vault write auth/userpass/users/<USERNAME> \
        password="SuperSecret" \
        policies=admin

    # Create VSO operator policy
    cat <<EOF | vault policy write vso-operator -
    path "secret/*" {
      capabilities = ["read", "list"]
    }
    EOF

    # Extract token audience and create operator role
    TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    PAYLOAD=$(echo "$TOKEN" | cut -d. -f2)
    AUD=$(echo "$PAYLOAD" | base64 -d | grep -o '"aud":[^"]*' | cut -d'"' -f4)

    vault write auth/kubernetes/role/vso-operator \
        bound_service_account_names=hashicorp-vault-secrets-operator-controller-manager \
        bound_service_account_namespaces=platform \
        policies=vso-operator \
        ttl=24h \
        audience="$AUD"

    echo "Bootstrap complete."

---
apiVersion: v1
kind: Pod
metadata:
  name: vault-cli
  namespace: platform
spec:
  containers:
  - name: cli
    image: hashicorp/vault:1.20.4 # align with Vault version running in the cluster
    command: ["sh"]
    args: ["-c", "sleep infinity"]   # keep pod running
    stdin: true
    tty: true
    volumeMounts:
    - name: vault-ca
      mountPath: /vault/ca
      readOnly: true
    - name: bootstrap-scripts
      mountPath: /scripts
      readOnly: true
    - name: vault-server-tls
      mountPath: /vault/userconfig/vault-server-tls
      readOnly: true
  volumes:
  - name: vault-ca
    secret:
      secretName: vault-internal-ca
  - name: vault-server-tls
    secret:
      secretName: vault-server-tls
  - name: bootstrap-scripts
    configMap:
      name: vault-bootstrap
      defaultMode: 0755
