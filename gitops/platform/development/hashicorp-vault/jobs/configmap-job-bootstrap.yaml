---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-bootstrap
  namespace: platform
data:
  bootstrap.sh: |
    #!/bin/sh
    set -e
    echo "Bootstrapping Vault..."

    export VAULT_ADDR=https://hashicorp-vault.platform.svc:8200
    export VAULT_CACERT=/vault/ca/ca.crt

    vault auth enable kubernetes || echo "Kubernetes auth already enabled"

    vault write auth/kubernetes/config \
        kubernetes_host="https://<apiserver-host>:443" \
        kubernetes_ca_cert=@/vault/ca/ca.crt \
        token_reviewer_jwt=@/var/run/secrets/kubernetes.io/serviceaccount/token

    cat <<EOF | vault policy write admin -
    path "*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }
    EOF

    vault auth enable userpass || echo "Userpass already enabled"
    vault write auth/userpass/users/$BOOTSTRAP_USER \
        password="$BOOTSTRAP_PASS" \
        policies=admin

    cat <<EOF | vault policy write vso-operator -
    # Observability namespace
    path "secret/data/observability/*" {
      capabilities = ["read"]
    }
    path "secret/metadata/observability/*" {
      capabilities = ["list"]
    }

    # Apps namespace
    path "secret/data/apps/*" {
      capabilities = ["read"]
    }
    path "secret/metadata/apps/*" {
      capabilities = ["list"]
    }

    # Platform namespace
    path "secret/data/platform/*" {
      capabilities = ["read"]
    }
    path "secret/metadata/platform/*" {
      capabilities = ["list"]
    }
    EOF

    TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    PAYLOAD=$(echo "$TOKEN" | cut -d. -f2)
    AUD=$(echo "$PAYLOAD" | base64 -d | jq -r .aud)

    vault write auth/kubernetes/role/vso-operator \
        bound_service_account_names=hashicorp-vault-secrets-operator-controller-manager \
        bound_service_account_namespaces=platform \
        policies=vso-operator \
        ttl=24h \
        audience="$AUD"

    echo "Bootstrap complete."