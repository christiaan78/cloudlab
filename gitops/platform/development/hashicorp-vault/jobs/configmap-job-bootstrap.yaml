---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-bootstrap
  namespace: platform
data:
  bootstrap.sh: |
    #!/bin/sh
    set -e
    echo "Bootstrapping Vault..."

    export VAULT_ADDR=https://hashicorp-vault.platform.svc.cluster.local:8200
    export VAULT_CACERT=/vault/ca/ca.crt

    vault write auth/kubernetes/config \
      kubernetes_host="https://kubernetes.default.svc" \
      kubernetes_ca_cert=@/var/run/secrets/kubernetes.io/serviceaccount/ca.crt \
      token_reviewer_jwt=@/var/run/secrets/kubernetes.io/serviceaccount/token \
      audience=vault


    cat <<EOF | vault policy write admin -
    path "*" {
      capabilities = ["create", "read", "update", "delete", "list", "sudo"]
    }
    EOF

    vault write auth/userpass/users/$BOOTSTRAP_USER \
        password="$BOOTSTRAP_PASS" \
        policies=admin

    cat <<EOF | vault policy write vso-operator -
    path "secret/data/k8s/*" {
      capabilities = ["read"]
    }
    path "secret/metadata/k8s/*" {
      capabilities = ["list"]
    }
    EOF

    TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
    PAYLOAD=$(echo "$TOKEN" | cut -d. -f2)
    AUD=$(echo "$PAYLOAD" | base64 -d | jq -r .aud)

    vault write auth/kubernetes/role/vso-operator \
        bound_service_account_names=default \
        bound_service_account_namespaces=platform \
        policies=vso-operator \
        ttl=24h \
        audience=vault

    vault write auth/kubernetes/role/vso-observability \
        bound_service_account_names=vso-observability \
        bound_service_account_namespaces=observability \
        policies=vso-operator \
        ttl=24h \
        audience=vault

    vault write auth/kubernetes/role/vso-traefik \
        bound_service_account_names=vso-traefik \
        bound_service_account_namespaces=ingress-traefik \
        policies=vso-operator \
        ttl=24h \
        audience=vault
        
    echo "Bootstrap complete."