apiVersion: batch/v1
kind: Job
metadata:
  name: pihole-bootstrap-adlists
  namespace: pihole
spec:
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: pihole-bootstrap
    spec:
      restartPolicy: OnFailure
      containers:
      - name: bootstrap
        image: alpine:3.20
        env:
        - name: PIHOLE_BASE
          value: "http://pihole-service.pihole.svc.cluster.local"
        - name: PIHOLE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: pihole-webpassword
              key: password
        volumeMounts:
        - name: adlists
          mountPath: /config
        command: ["/bin/sh","-ceu"]
        args:
        - |
          apk add --no-cache curl jq

          echo "Authenticating to Pi-hole API..."
          PASS_JSON="$(printf '%s' "${PIHOLE_PASSWORD}" | jq -Rs .)"
          AUTH_JSON="$(curl -fsSL \
            -X POST "${PIHOLE_BASE}/api/auth" \
            -H "accept: application/json" \
            -H "content-type: application/json" \
            --data "{\"password\":${PASS_JSON}}")"

          SID="$(echo "$AUTH_JSON" | jq -r '.session.sid // empty')"
          if [ -z "$SID" ]; then
            echo "ERROR: Could not obtain SID from /api/auth response:"
            echo "$AUTH_JSON"
            exit 1
          fi

          SID_ENC="$(printf '%s' "$SID" | jq -sRr @uri)"

          echo "Upserting adlists..."
          while IFS= read -r url; do
            url="$(printf '%s' "$url" | tr -d '\r')"
            [ -z "$url" ] && continue
            case "$url" in \#*) continue ;; esac

            enc="$(printf '%s' "$url" | jq -sRr @uri)"
            payload='{"comment":"managed-by-gitops","type":"block","enabled":true,"groups":[0]}'

            code="$(curl -sS -o /dev/null -w '%{http_code}' \
              -X PUT "${PIHOLE_BASE}/api/lists/${enc}?type=block&sid=${SID_ENC}" \
              -H "accept: application/json" \
              -H "content-type: application/json" \
              --data "$payload" || true)"

            echo "  ${url} -> HTTP ${code}"
          done < /config/adlists.txt

          echo "Running gravity update..."
          # Note: gravity endpoint output is not necessarily JSON.
          curl -sS \
            -X POST "${PIHOLE_BASE}/api/action/gravity?sid=${SID_ENC}" \
            --max-time 1800 || true

          echo "Done."
      volumes:
      - name: adlists
        configMap:
          name: pihole-adlists
